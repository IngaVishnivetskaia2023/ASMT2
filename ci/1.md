### Topics
#### Describe your project CI/CD pipeline

```
image: node:20-alpine

variables:
  FF_USE_FASTZIP: "true"
  # These can be specified per job or per pipeline
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

stages:
  - deps
  - lint
  - unit
  - sonar
  - build
  - deploy

deps:
  tags:
      - private-runner
  stage: deps
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules
      - .yarn
    policy: pull-push
  script:
    - yarn install --cache-folder .yarn
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+\-\d+\.\d+\.\d+$/'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
      changes:
          paths:
              - scripts/**/*
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

lint:eslint:
  tags:
      - private-runner
  stage: lint
  script:
    - npx eslint --format gitlab .
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
      - .yarn
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
      changes:
          paths:
              - scripts/**/*
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
  artifacts:
    reports:
      codequality: gl-codequality.json

lint:shell:
    stage: lint
    tags:
      - private-runner
    cache: []
    script:
        - apk --no-cache update
        - apk --no-cache add shellcheck
        - shellcheck scripts/*.sh
    rules:
        - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
          changes:
              paths:
                  - scripts/**/*

unit:
  stage: unit
  tags:
      - private-runner
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  script:
    - yarn test-ci
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
      - .yarn
    policy: pull
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
      changes:
          paths:
              - scripts/**/*
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
  artifacts:
    when: always
    paths:
      - coverage/
    reports:
      junit:
        - junit.xml


sonar:
  stage: sonar
  before_script: []
  image:
    name: sonarsource/sonar-scanner-cli:11.1.1.1661_6.2.1
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
    GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  # allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
      changes:
          paths:
              - scripts/**/*
      when: never
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

.deploy_image_script:
  stage: deploy
  tags:
      - private-runner
  image:
    name: amazon/aws-cli:latest
    entrypoint:
      - '/usr/bin/env'
  script:
    - aws s3 sync build/ s3://$S3_BUCKET

.build_image_script:
  stage: build
  tags:
      - private-runner
  script:
    - yarn build
  cache:
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
      - .yarn
    policy: pull
  artifacts:
    name: "$CI_JOB_NAME"
    paths:
      - build/
    when: always

.deploy_templates_script:
  stage: deploy
  tags:
      - private-runner
  before_script:
      - apk --no-cache update
      - apk --no-cache add httpie bash ca-certificates
      - cp ${ENV_EE} .env.ee
      - export REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
  script:
      - bash scripts/deploy-templates.sh 

build_dv:
  extends: .build_image_script
  variables:
    REACT_APP_GIT_TAG: "0000.00.00-00.00"
    REACT_APP_GIT_SHA: $CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" # Run code quality job in merge request pipelines
      changes:
          paths:
              - scripts/**/*
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  environment:
    name: dv

build_ut:
  extends: .build_image_script
  variables:
    REACT_APP_GIT_TAG: $CI_COMMIT_TAG
    REACT_APP_GIT_SHA: $CI_COMMIT_SHORT_SHA
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+\-\d+\.\d+\.\d+$/'
  environment:
    name: ut

deploy_dv:
  extends: .deploy_image_script
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
  dependencies:
    - "build_dv"
  environment:
    name: dv
    url: $REACT_APP_COGNITO_REDIRECT_URI

deploy_ut:
  extends: .deploy_image_script
  dependencies:
    - "build_ut"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+\-\d+\.\d+\.\d+$/'
  environment:
    name: ut
    url: $REACT_APP_COGNITO_REDIRECT_URI

templates_dv:
  extends: .deploy_templates_script
  environment:
    name: dv
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        paths:
          - templates/**/*

templates_ut:
  extends: .deploy_templates_script
  environment:
    name: ut
  rules:
    - if: '$CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+\-\d+\.\d+\.\d+$/'
      changes:
        paths:
          - templates/**/*
```

### 1. CI/CD Pipeline Структура
Pipeline состоит из нескольких этапов, которые последовательно выполняются. Каждый этап охватывает специфический процесс разработки или развертывания:

- deps: Установка зависимостей.
- lint: Анализ кода (ESLint и Shellcheck).
- unit: Запуск модульных тестов с расчетом покрытия.
- sonar: Анализ качества кода с использованием SonarQube.
- build: Сборка проекта.
- deploy: Развертывание артефактов (разделяется между окружениями dv и ut).

### 2. Детальное описание этапов
- a. deps (Установка зависимостей)
Этот этап отвечает за установку зависимостей проекта через Yarn:

Используется кэш для ускорения повторных сборок (node_modules и .yarn).
Устанавливает зависимости с использованием команды:

```
yarn install --cache-folder .yarn
```

Работает только при следующих условиях:
- Это основная ветка ($CI_DEFAULT_BRANCH).
- Это тег коммита, соответствующий шаблону семантического версионирования.
- Это событие слияния (merge request).

### b. lint (Анализ кода)

#### lint:eslint
Линтер для JavaScript/TypeScript файлов:

- Использует eslint с форматом gitlab для представления результатов.
- Генерирует отчет о качестве кода в формате gl-codequality.json.
- Выполняется только на этапе pull-request (merge_request_event).
#### lint:shell
Линтер для Shell-скриптов:
- Устанавливает shellcheck и анализирует все *.sh файлы.
- Работает на основе изменений в папке scripts.

### c. unit (Модульные тесты)
Этот этап отвечает за автоматическое тестирование:

Выполняет модульные тесты с помощью команды:

```
yarn test-ci
```
- Извлекает данные покрытия тестов с помощью регулярного выражения.
- Генерирует отчет JUnit (junit.xml) и покрытие тестов. Все артефакты (например, coverage/) сохраняются.

Условия выполнения:
- Это событие merge request (merge_request_event).
- Обнаружены изменения в scripts/**/*.

### d. sonar (Анализ качества кода)
SonarQube используется для измерения различных метрик качества кода:

- Подключается Docker-образ sonarsource/sonar-scanner-cli.
- Используются переменные окружения для кэширования анализа и расширенного доступа к git.
- Запускает сканирование с помощью команды:
```
sonar-scanner
```
Выполняется при событиях слияния на основе условий изменений в scripts/**/*.

### e. build (Сборка проекта)
Шаблон: .build_image_script
- Выполняет процесс сборки, используя Yarn:
```
yarn build
```
- Сохраняет артефакты (build/) для последующего развертывания.
- Используется кэш node_modules и .yarn.
- 
Сборка для окружений:
#### build_dv:

- Срабатывает для основной ветки ($CI_DEFAULT_BRANCH), например, develop.
- Устанавливает уникальные переменные среды, такие как REACT_APP_GIT_TAG и REACT_APP_GIT_SHA.
#### build_ut:

- Выполняется для тегов коммитов, соответствующих регулярному выражению.
- Также устанавливает переменные.

### f. deploy (Развертывание)
Шаблон: .deploy_image_script
Использует AWS CLI для загрузки артефактов на S3:

```
aws s3 sync build/ s3://$S3_BUCKET
```

#### Развертывание для окружений:
#### deploy_dv:

- Выполняется для основной ветки ($CI_DEFAULT_BRANCH).
- Зависит от сборки build_dv.
- Связывает URL-адрес для конкретной среды.
#### deploy_ut:

- Выполняется для тегов коммитов.
- Зависит от сборки build_ut.

### g. Обновление шаблонов
Отдельный этап для размещения обновленных ресурсов (шаблонов) в целях подготовки окружений:

#### templates_dv:

- Работает для основной ветки, если изменения произошли в templates/**/*.
#### templates_ut:

- Выполняется при публикации тегов и изменениях в templates.
- Скрипт развертывания используется из файла scripts/deploy-templates.sh.

- CI vs CD vs CD (https://www.atlassian.com/continuous-delivery/ci-vs-ci-vs-cd, https://youtu.be/aoMfbgF2D_4)
- How would you setup CI/CD on the next ideal project
- Preparing pre-hooks, commit styles, CI/CD setup and configuration, linters rules
- Branching Strategy types, their pros/cons (connection between branching strategy and development process, team size, project structure, available environments, large / small merges strategy, feature / protected branches)
- Feature Branch Workflow
- Git Flow
- GitHub flow
- Release Flow / One Flow
- Forking Workflow
- release strategies (Blue/Green, rolling release, canary deployments)
- Merge, Rebase, Interactive Rebase, Squash Rebase
